!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).atlas={})}(this,function(t){"use strict";class e{constructor(){this.state={},this.listeners={}}set(t,e){this.state[t]=e,this.listeners[t]&&this.listeners[t].forEach(t=>t(e))}get(t){return this.state[t]}watch(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}unwatch(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(t=>t!==e))}}class n{constructor(){this.handlers={}}register(t,e){this.handlers[t]=e}execute(t,e){const n=this.handlers[t];if(n)return n(e);throw new Error(`No handler registered for command: ${t}`)}}function s(t,e){if(!1===e)return t;var n=Math.pow(10,void 0===e?6:e);return Math.round(t*n)/n}var i=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};class o{static clip(t,e){return t}}class r{static clip(t,e){return t}}class a{constructor(t,e){if(t){const n=e?[t,e]:t;for(const t of n)this.extend(t)}}extend(t){let e,n;if(t instanceof l)e=t,n=t;else{if(!(t instanceof a))return t=c(t)||h(t),this.extend(t);if(e=t._southWest,n=t._northEast,!e||!n)return this}return this._southWest||this._northEast?(this._southWest.lat=Math.min(e.lat,this._southWest.lat),this._southWest.lng=Math.min(e.lng,this._southWest.lng),this._northEast.lat=Math.max(n.lat,this._northEast.lat),this._northEast.lng=Math.max(n.lng,this._northEast.lng)):(this._southWest=new l(e.lat,e.lng),this._northEast=new l(n.lat,n.lng)),this}pad(t){const e=this._southWest,n=this._northEast,s=Math.abs(e.lat-n.lat)*t,i=Math.abs(e.lng-n.lng)*t;return new a(new l(e.lat-s,e.lng-i),new l(n.lat+s,n.lng+i))}getCenter(){return new l((this._southWest.lat+this._northEast.lat)/2,(this._southWest.lng+this._northEast.lng)/2)}getSouthWest(){return this._southWest}getNorthEast(){return this._northEast}getNorthWest(){return new l(this.getNorth(),this.getWest())}getSouthEast(){return new l(this.getSouth(),this.getEast())}getWest(){return this._southWest.lng}getSouth(){return this._southWest.lat}getEast(){return this._northEast.lng}getNorth(){return this._northEast.lat}contains(t){t="number"==typeof t[0]||t instanceof l||"lat"in t?c(t):h(t);const e=this._southWest,n=this._northEast;let s,i;return t instanceof a?(s=t.getSouthWest(),i=t.getNorthEast()):s=i=t,s.lat>=e.lat&&i.lat<=n.lat&&s.lng>=e.lng&&i.lng<=n.lng}intersects(t){t=h(t);const e=this._southWest,n=this._northEast,s=t.getSouthWest(),i=t.getNorthEast(),o=i.lat>=e.lat&&s.lat<=n.lat,r=i.lng>=e.lng&&s.lng<=n.lng;return o&&r}toBBoxString(){return[this.getWest(),this.getSouth(),this.getEast(),this.getNorth()].join(",")}equals(t,e){return!!t&&(t=h(t),this._southWest.equals(t.getSouthWest(),e)&&this._northEast.equals(t.getNorthEast(),e))}isValid(){return!(!this._southWest||!this._northEast)}}function h(t,e){return t instanceof a?t:new a(t,e)}class l{constructor(t,e,n){if(isNaN(t)||isNaN(e))throw new Error(`Invalid GeoPoint object: (${t}, ${e})`);this.lat=+t,this.lng=+e,void 0!==n&&(this.alt=+n)}equals(t,e=1e-9){if(!t)return!1;t=c(t);return Math.max(Math.abs(this.lat-t.lat),Math.abs(this.lng-t.lng))<=e}toString(t){return`GeoPoint(${s(this.lat,t)}, ${s(this.lng,t)})`}distanceTo(t){t=c(t);const e=Math.PI/180,n=this.lat*e,s=t.lat*e,i=Math.sin((t.lat-this.lat)*e/2),o=Math.sin((t.lng-this.lng)*e/2),r=i*i+Math.cos(n)*Math.cos(s)*o*o;return 6371e3*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))}toArea(t){const e=180*t/40075017,n=e/Math.cos(Math.PI/180*this.lat);return h([this.lat-e,this.lng-n],[this.lat+e,this.lng+n])}clone(){return new l(this.lat,this.lng,this.alt)}}function c(t,e,n){return t instanceof l?t:i(t)&&"object"!=typeof t[0]?3===t.length?new l(t[0],t[1],t[2]):2===t.length?new l(t[0],t[1]):null:null==t?t:"object"==typeof t&&"lat"in t?new l(t.lat,"lng"in t?t.lng:t.lon,t.alt):void 0===e?null:new l(t,e,n)}const u=Math.trunc||function(t){return t>0?Math.floor(t):Math.ceil(t)};class d{constructor(t,e,n){this.x=n?Math.round(t):t,this.y=n?Math.round(e):e}clone(){return new d(this.x,this.y)}add(t){const e=this.clone();return e.x+=t.x,e.y+=t.y,e}subtract(t){const e=this.clone();return e.x-=t.x,e.y-=t.y,e}divideBy(t){const e=this.clone();return e.x/=t,e.y/=t,e}multiplyBy(t){const e=this.clone();return e.x*=t,e.y*=t,e}scaleBy(t){return new d(this.x*t.x,this.y*t.y)}unscaleBy(t){return new d(this.x/t.x,this.y/t.y)}round(){const t=this.clone();return t.x=Math.round(t.x),t.y=Math.round(t.y),t}floor(){const t=this.clone();return t.x=Math.floor(t.x),t.y=Math.floor(t.y),t}ceil(){const t=this.clone();return t.x=Math.ceil(t.x),t.y=Math.ceil(t.y),t}trunc(){const t=this.clone();return t.x=u(t.x),t.y=u(t.y),t}distanceTo(t){const e=t.x-this.x,n=t.y-this.y;return Math.sqrt(e*e+n*n)}equals(t){return t.x===this.x&&t.y===this.y}contains(t){return Math.abs(t.x)<=Math.abs(this.x)&&Math.abs(t.y)<=Math.abs(this.y)}toString(){return`PixelPoint(${s(this.x)}, ${s(this.y)})`}}class g{constructor(t,e={}){this.engine=t,this.stateManager=t.stateManager,this.stateManager.set("viewport.center",e.center||[0,0]),this.stateManager.set("viewport.zoom",e.zoom||1)}navigateTo({center:t,zoom:e}){t&&this.stateManager.set("viewport.center",t),e&&this.stateManager.set("viewport.zoom",e)}zoomIn(t=1){const e=this.stateManager.get("viewport.zoom");this.navigateTo({zoom:e+t})}zoomOut(t=1){const e=this.stateManager.get("viewport.zoom");this.navigateTo({zoom:e-t})}panBy(t){const e=this.stateManager.get("viewport.center"),n=this.stateManager.get("viewport.zoom"),s=this.engine.projection,i=s.projectToPixel(c(e),n).add(new d(t.x,t.y)),o=s.unprojectFromPixel(i,n);this.navigateTo({center:[o.lat,o.lng]})}getPixelOrigin(){const t=this.stateManager.get("viewport.center"),e=this.stateManager.get("viewport.zoom"),n=this.engine.projection.projectToPixel(c(t),e),s=this.getSize().divideBy(2);return n.subtract(s).round()}getSize(){const t=this.engine.container;return new d(t.clientWidth,t.clientHeight)}getPixelBounds(){const t=this.getSize();return new a([0,0],[t.x,t.y])}}class m{constructor(t){this.engine=t,this.surfaces=[]}mount(t){this.surfaces.push(t),t.onMount&&t.onMount(),this.engine.renderPipeline.render()}unmount(t){const e=this.surfaces.indexOf(t);e>-1&&(t.onUnmount&&t.onUnmount(),this.surfaces.splice(e,1),this.engine.renderPipeline.render())}}class p{constructor(t){this.points=t}}class _{constructor(t){this.points=t}}class w{constructor(t){this.engine=t,this.renderer=null,this._initRenderer()}_initRenderer(){const t=document.createElement("canvas");this.engine.container.appendChild(t),this.renderer=t.getContext("2d"),this.engine.stateManager.watch("viewport.resize",this._onResize.bind(this)),this._onResize()}_onResize(){const t=this.engine.container;this.renderer.canvas.width=t.clientWidth,this.renderer.canvas.height=t.clientHeight,this.render()}render(){this.renderer.clearRect(0,0,this.renderer.canvas.width,this.renderer.canvas.height);const t=this.engine.surfaces.surfaces;for(const e of t)e.render&&e.render(this.renderer)}draw(t,e){const n=this.engine.projection,s=this.engine.stateManager.get("viewport.zoom"),i=this.engine.viewport.getPixelOrigin(),o=this.engine.viewport.getPixelBounds();t.strokeStyle=e.style.color,t.lineWidth=e.style.weight,t.fillStyle=e.style.fillColor,t.globalAlpha=e.style.fillOpacity,e.geometry instanceof l?this._drawPoint(t,e.geometry,n,s,i):e.geometry instanceof p?this._drawLine(t,e.geometry,n,s,i,o):e.geometry instanceof _&&this._drawPolygon(t,e.geometry,n,s,i,o)}_toPixelPoints(t,e,n,s){return t.map(t=>e.projectToPixel(t,n).subtract(s))}_drawPoint(t,e,n,s,i){const o=n.projectToPixel(e,s).subtract(i);t.beginPath(),t.arc(o.x,o.y,5,0,2*Math.PI),t.fill(),t.stroke()}_drawLine(t,e,n,s,i,r){const a=this._toPixelPoints(e.points,n,s,i),h=o.clip(a,r);if(0!==h.length){t.beginPath();for(let e=0;e<h.length;e++){const n=h[e];0===e?t.moveTo(n.x,n.y):t.lineTo(n.x,n.y)}t.stroke()}}_drawPolygon(t,e,n,s,i,o){const a=this._toPixelPoints(e.points,n,s,i),h=r.clip(a,o);if(0!==h.length){t.beginPath();for(let e=0;e<h.length;e++){const n=h[e];0===e?t.moveTo(n.x,n.y):t.lineTo(n.x,n.y)}t.closePath(),t.fill(),t.stroke()}}}const f=6378137;class y{constructor(){this.R=f,this.MAX_LATITUDE=85.0511287798;const t=f*Math.PI;this.bounds=new a([-t,-t],[t,t])}project(t){const e=Math.PI/180,n=this.MAX_LATITUDE,s=Math.max(Math.min(n,t.lat),-n),i=Math.sin(s*e);return new d(this.R*t.lng*e,this.R*Math.log((1+i)/(1-i))/2)}unproject(t){const e=180/Math.PI;return new l((2*Math.atan(Math.exp(t.y/this.R))-Math.PI/2)*e,t.x*e/this.R)}}class v{constructor(t,e,n,s){if(Array.isArray(t))return this._a=t[0],this._b=t[1],this._c=t[2],void(this._d=t[3]);this._a=t,this._b=e,this._c=n,this._d=s}transform(t,e=1){const n=t.clone();return n.x=e*(this._a*n.x+this._b),n.y=e*(this._c*n.y+this._d),n}untransform(t,e=1){return new d((t.x/e-this._b)/this._a,(t.y/e-this._d)/this._c)}}class x{constructor(){this.code="EPSG:3857",this.projection=new y;const t=.5/(Math.PI*this.projection.R);this.transformation=new v(t,.5,-t,.5)}project(t){return this.projection.project(t)}unproject(t){return this.projection.unproject(t)}projectToPixel(t,e){const n=this.project(t),s=this.scale(e);return this.transformation.transform(n,s)}unprojectFromPixel(t,e){const n=this.scale(e),s=this.transformation.untransform(t,n);return this.unproject(s)}scale(t){return 256*Math.pow(2,t)}zoom(t){return Math.log(t/256)/Math.LN2}}class b{constructor(t){this.engine=t,this._behaviors={},this._events=["click","dblclick","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu","wheel"]}add(t,e){this._behaviors[e]=t}enable(t){const e=this._behaviors[t];e&&e.enable()}disable(t){const e=this._behaviors[t];e&&e.disable()}_initEvents(){const t=this.engine.container;for(const e of this._events)t.addEventListener(e,this._handleEvent.bind(this))}_handleEvent(t){for(const e in this._behaviors){const n=this._behaviors[e];if(n.enabled()){const e=n[t.type];e&&"function"==typeof e&&e.call(n,t)}}}}class M{constructor(t){this.engine=t,this._enabled=!1}enable(){this._enabled||(this._enabled=!0,this.addHooks())}disable(){this._enabled&&(this._enabled=!1,this.removeHooks())}enabled(){return this._enabled}addHooks(){throw new Error("The addHooks() method must be implemented by subclasses.")}removeHooks(){throw new Error("The removeHooks() method must be implemented by subclasses.")}}class P extends M{constructor(t){super(t),this._isDragging=!1,this._lastPos=null}addHooks(){this.engine.container.addEventListener("mousedown",this._onMouseDown.bind(this)),this.engine.container.addEventListener("mouseup",this._onMouseUp.bind(this)),this.engine.container.addEventListener("mousemove",this._onMouseMove.bind(this))}removeHooks(){this.engine.container.removeEventListener("mousedown",this._onMouseDown.bind(this)),this.engine.container.removeEventListener("mouseup",this._onMouseUp.bind(this)),this.engine.container.removeEventListener("mousemove",this._onMouseMove.bind(this))}_onMouseDown(t){0===t.button&&(this._isDragging=!0,this._lastPos={x:t.clientX,y:t.clientY},this.engine.container.style.cursor="grabbing")}_onMouseUp(){this._isDragging=!1,this.engine.container.style.cursor="grab"}_onMouseMove(t){if(!this._isDragging)return;const e={x:t.clientX,y:t.clientY},n={x:this._lastPos.x-e.x,y:this._lastPos.y-e.y};this.engine.viewport.panBy(n),this._lastPos=e}}class E extends M{addHooks(){this.engine.container.addEventListener("wheel",this._onWheel.bind(this))}removeHooks(){this.engine.container.removeEventListener("wheel",this._onWheel.bind(this))}_onWheel(t){t.preventDefault();const e=t.deltaY;e>0?this.engine.viewport.zoomOut():e<0&&this.engine.viewport.zoomIn()}}class z{constructor(t){this.engine=t,this._widgets=[],this._corners={},this._initLayout()}add(t){this._widgets.push(t),t._container=t.onAdd(this.engine);const e=t.options.position||"topright",n=this._corners[e];return n&&(e.includes("bottom")?n.insertBefore(t.getContainer(),n.firstChild):n.appendChild(t.getContainer())),this}remove(t){const e=this._widgets.indexOf(t);if(e>-1){this._widgets.splice(e,1);const n=t.getContainer();n&&n.parentNode&&n.parentNode.removeChild(n),t.onRemove&&t.onRemove(this.engine)}return this}_initLayout(){const t=this.engine.container;this._controlContainer=document.createElement("div"),this._controlContainer.className="atlas-widget-container",t.appendChild(this._controlContainer),this._createCorner("top","left"),this._createCorner("top","right"),this._createCorner("bottom","left"),this._createCorner("bottom","right")}_createCorner(t,e){const n=`atlas-widget-${t} atlas-widget-${e}`,s=document.createElement("div");s.className=n,this._corners[t+e]=s,this._controlContainer.appendChild(s)}}class T{constructor(t,e={}){this.engine=t,this.options={...e},this._container=null}onAdd(t){throw new Error("The onAdd() method must be implemented by subclasses.")}onRemove(t){}getContainer(){return this._container}}class W extends T{constructor(t,e){super(t,{position:"topleft",zoomInText:"+",zoomInTitle:"Zoom in",zoomOutText:"−",zoomOutTitle:"Zoom out",...e})}onAdd(t){const e=document.createElement("div");return e.className="atlas-zoom-widget atlas-bar",this._zoomInButton=this._createButton(this.options.zoomInText,this.options.zoomInTitle,"atlas-zoom-in",e,()=>this.engine.viewport.zoomIn()),this._zoomOutButton=this._createButton(this.options.zoomOutText,this.options.zoomOutTitle,"atlas-zoom-out",e,()=>this.engine.viewport.zoomOut()),this.engine.stateManager.watch("viewport.zoom",()=>this._updateDisabled()),this._updateDisabled(),e}_createButton(t,e,n,s,i){const o=document.createElement("a");return o.innerHTML=t,o.href="#",o.title=e,o.className=n,o.setAttribute("role","button"),o.setAttribute("aria-label",e),o.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),i()}),s.appendChild(o),o}_updateDisabled(){const t=this.engine.stateManager.get("viewport.zoom"),e=this.engine.stateManager.get("viewport.minZoom")||0,n=this.engine.stateManager.get("viewport.maxZoom")||18;this._zoomInButton.classList.remove("atlas-disabled"),this._zoomOutButton.classList.remove("atlas-disabled"),t<=e&&this._zoomOutButton.classList.add("atlas-disabled"),t>=n&&this._zoomInButton.classList.add("atlas-disabled")}}class j{constructor(t,s={}){if(this.container=document.getElementById(t),!this.container)throw new Error(`Container with id "${t}" not found.`);this.stateManager=new e,this.commandBus=new n,this.projection=s.projection||new x,this.viewport=new g(this,s),this.surfaces=new m(this),this.renderPipeline=new w(this),this.widgets=new z(this),this.interaction=new b(this),this.widgets.add(new W(this)),this.interaction.add(new P(this),"dragPan"),this.interaction.add(new E(this),"scrollWheelZoom"),this.interaction.enable("dragPan"),this.interaction.enable("scrollWheelZoom"),this.interaction._initEvents()}}class B{constructor(t){this.engine=t}onMount(){}onUnmount(){}render(t){throw new Error("The render() method must be implemented by subclasses.")}}t.Area=a,t.AtlasEngine=j,t.Feature=class{constructor(t,e={},n={}){this.geometry=t,this.properties=e,this.style={color:"blue",weight:3,fillColor:"blue",fillOpacity:.2,...n}}},t.GeoLine=p,t.GeoPoint=l,t.GeoPolygon=_,t.PixelPoint=d,t.TileSurface=class extends B{constructor(t,e){super(t),this.options={tileSize:256,subdomains:"abc",minZoom:0,maxZoom:18,...e},this._tiles={},this.engine.stateManager.watch("viewport.center",()=>this.engine.renderPipeline.render()),this.engine.stateManager.watch("viewport.zoom",()=>this.engine.renderPipeline.render())}_getTileUrl(t){const e={x:t.x,y:t.y,z:t.z,s:this.options.subdomains[Math.floor(Math.random()*this.options.subdomains.length)]};return this.options.urlTemplate.replace(/\{(\w+)\}/g,(t,n)=>e[n])}render(t){const e=Math.round(this.engine.stateManager.get("viewport.zoom"));if(e<this.options.minZoom||e>this.options.maxZoom||!this.options.urlTemplate)return;this.engine.stateManager.get("viewport.center");this.engine.projection.scale(e);const n=this.options.tileSize,s=this.engine.viewport.getPixelOrigin(),i=this.engine.viewport.getSize(),o=this._getTileRange(s,i,n);for(let i=o.min.y;i<=o.max.y;i++)for(let r=o.min.x;r<=o.max.x;r++){const o={x:r,y:i,z:e},a=`${o.x}:${o.y}:${o.z}`;if(this._tiles[a]||this._createTile(o),this._tiles[a]&&this._tiles[a].complete&&0!==this._tiles[a].naturalWidth){const e=this._tiles[a],i=this._getTilePos(o,s,n);t.drawImage(e,i.x,i.y,n,n)}}}_getTilePos(t,e,n){return{x:t.x*n-e.x,y:t.y*n-e.y}}_getTileRange(t,e,n){return{min:t.divideBy(n).floor(),max:t.add(e).divideBy(n).floor()}}_createTile(t){const e=`${t.x}:${t.y}:${t.z}`;if(this._tiles[e])return;const n=new Image;n.crossOrigin="Anonymous",this._tiles[e]=n,n.onload=()=>{this.engine.renderPipeline.render()},n.onerror=()=>{console.error(`Failed to load tile: ${n.src}`)},n.src=this._getTileUrl(t)}},t.VectorSurface=class extends B{constructor(t,e=[]){super(t),this.features=e,this.engine.stateManager.watch("viewport.center",()=>this.engine.renderPipeline.render()),this.engine.stateManager.watch("viewport.zoom",()=>this.engine.renderPipeline.render())}addFeature(t){this.features.push(t),this.engine.renderPipeline.render()}removeFeature(t){const e=this.features.indexOf(t);e>-1&&(this.features.splice(e,1),this.engine.renderPipeline.render())}render(t){for(const e of this.features)this.engine.renderPipeline.draw(t,e)}},t.default=j,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=atlas-v2.min.js.map
